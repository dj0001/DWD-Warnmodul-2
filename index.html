<!DOCTYPE html>
<html lang="de">

<head>
	<title>DWD- Warnmodul 2</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="dj0001">
	<link rel="icon" type="image/png" sizes="192x192" href="icons/warn.png">

<!--

Diese Datei illustriert als "Warnmodul2" die Darstellung der Warnungen des Deutschen Wetterdienstes als WMS-Dienst aus dem Server maps.dwd.de in einem JavaScript-basierten Web-mapping-Client.
Verwendete Bestandteile:
- als zentrales Element wird die JS-Bibliothek leaflet zur Erzeugung einer dynamsichen, interaktiven Karte in einem html-div-Element genutzt
- die JS-Biblithek jQuery kommt für die Abfrage von Warninformationen via AJAX und JSONP zur Anwendung
- das leaflet-Plugin BetterWMS wird für eine einfache GetFeatureInfo-Abfrage von Warndetails verwendet
	https://gist.github.com/rclark/6908938	

Leaflet bietet eine Vielzahl an Konfigurationsoptionen und Erweiterungen, welche unter https://leafletjs.com/ dokumentiert sind.
Durch mögliche Einschränkungen von Zoom, Auschnitt und Interaktion sind auch örtlich gebundene Karten realisierbar. Des weiteren können alternative Hintergrundkarten, sowie zusätzliche Informationen aus anderen Diensten mit eingebunden werden.

Weiterentwicklungen und Veränderungen des "Warnmodul2"-Codes sind ausdrücklich erwünscht, die Darstellung der DWD-Warnungen sollte allerdings immer in den original-Farben (https://www.dwd.de/DE/wetter/warnungen_aktuell/kriterien/farbskala.html?nn=605882) erfolgen. Eine eventuell duchgeführte Filterung von Warnungen sollte für Nutzer entsprechend ersichtlich sein.
Anregungen zur Nutzung oder beispielhafte Weiterentwicklungen nehmen wir gerne unter opendata@dwd.de entgegen um sie der Allgemeinheit verfügbar zu machen.

-->

	<!-- Leaflet JavaScript Bibliothek für interaktive Karten -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" crossorigin=""/>

    <!-- jquery für ajax-Anfragen
	<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script> -->
	
	<!-- BetterWMS stellt vereinfachte getFeatureInfo-Abfragen für WMS-Layer bereit; alternativ kann z.B. https://github.com/heigeo/leaflet.wms oder eigener Code verwendet werden
	Die Funktionen wurden angepasst, um JSONP-Anfragen durchzuführen und ausgewählte Elemente der Feature-Info im Popup darzustellen; Änderungen sind in leaflet-betterwms.js entsprechen markiert
	-->
	<script src="./leaflet-betterwms_dj.js"></script>

</head>
<body>

<!-- hier wird der Kartencontainer definiert, in welchem anschließend die Karte dargestellt wird -->
<div id="kartencontainer" style="width: 98vw; height: 100vh;"></div>  <!-- width: 800px; height: 600px; -->


<script>
	(function(){
	// Leaflet-Kartenobjekt im referenzierten div erstellen und initiale Optionen für Karte übergeben
	var karte = L.map('kartencontainer', {
		// Mittelpunkt der Karte als Breiten- und Längengrad, bspw. 50.0956° N, 8.7761° E für Offenbach
		center: [50.0956, 8.7761],
		// initiales Zoomlevel
		zoom: 7, 
		// interaktivität der Karte kann mit Optionen gesteuert werden
		zoomControl: true,
		dragging: true,
		attributionControl: true
	});

	// OSM-Hintergrundslayer definieren
	var osmlayer =  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: 'Map data: &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
		maxZoom: 18
	});

	// Warnungs-Layer vom DWD-Geoserver - betterWms fügt Möglichkeiten zur GetFeatureInfo hinzu
	var warnlayer = L.tileLayer.betterWms("https://maps.dwd.de/geoserver/dwd/wms/", {  //https://maps.dwd.de/geoproxy_warnungen/service/
		layers: 'Warnungen_Gemeinden_vereinigt',
		// eigene Styled Layer Descriptor (SLD) können zur alternativen Anzeige der Warnungen genutzt werden (https://docs.geoserver.org/stable/en/user/styling/sld/reference/)
		//sld: 'https://eigenerserver/alternativer.sld',
		format: 'image/png',
		transparent: true,
		opacity: 0.8,
		attribution: 'Warndaten: &copy; <a href="https://www.dwd.de">DWD</a>'
	});

	// CQL_FILTER können benutzt werden um angezeigte Warnungen zu filtern (https://docs.geoserver.org/stable/en/user/tutorials/cql/cql_tutorial.html)
	// Filterung kann auf Basis der verschiedenen properties der Warnungen erfolgen (bspw. EC_II, EC_GROUP, DESCRIPTION ... ) siehe https://www.dwd.de/DE/wetter/warnungen_aktuell/objekt_einbindung/einbindung_karten_geowebservice.pdf
 	// warnlayer.setParams({CQL_FILTER:"DESCRIPTION LIKE '%Sturm%'"});
 	var qs=decodeURI(location.search.slice(1)); if(isNaN(qs) &&!qs.match(/^ort=/)) warnlayer.setParams({CQL_FILTER:"EVENT IN ('"+qs.replace(/,/g,"','")+"')"})  //
	// Filter können zur Laufzeit, z.B. über Nutzereingaben angepasst werden
 	//delete warnlayer.wmsParams.CQL_FILTER;
 	//warnlayer.redraw();

 	// Layer mit neutraler Darstellung der Gemeinde-Warngebiete
	var gemeindelayer = L.tileLayer.wms("https://maps.dwd.de/geoproxy_warnungen/service/", {
		layers: 'Warngebiete_Gemeinden',
		format: 'image/png',
		styles: '',
		transparent: true,
		opacity: 0.6,
		attribution: 'Geobasisdaten Gemeinden: &copy; <a href="https://www.bkg.de">BKG</a> 2015 (Daten verändert)'
	});

	// Layerlisten für die Layercontrol erstellen und dabei initial aktive Layer zur Karte hinzufügen
	var baseLayers = {
			"OpenStreetMap": osmlayer.addTo(karte)
	};
		var satlayer = L.tileLayer.wms("https://maps.dwd.de/geoserver/dwd/wms/", {
		layers: 'dwd:SAT_EU_central_RGB_cloud',  //GefuehlteTemp
		format: 'image/png',
		styles: '',
		transparent: true,
		opacity: 0.6,
		attribution: 'Satellitenbild METEOSAT (RGB) Europa Zentral: &copy; <a href="http://www.dwd.de">DWD</a>'
	});
	var overLayers = {
			"<span title='DWD Geoserver dwd:Warnungen_Gemeinden_vereinigt'>Gemeinde vereinigt</span>": warnlayer.addTo(karte),
			"<span title='DWD Geoserver Gemeindewarngebiete'>Warngebiete (Gemeinden)</span>": gemeindelayer,
			"<span title='Satellitenbild METEOSAT'>Satellitenbild</span>": satlayer
	};

	// Layercontrol-Element erstellen und hinzufügen
    L.control.layers(baseLayers, overLayers).addTo(karte);

	// Demo-Marker mit Popup hinzufügen
	//var marker = L.marker([50.099444, 8.770833]).addTo(karte);
	//marker.bindPopup("<b>Deutscher Wetterdienst</b><br>Wetter und Klima aus einer Hand").openPopup();
	
	//addons DJ
var auto=300  //update-interval in s (alle 5 min; 2e6 no-updates)  //edit here

  auto=Math.max(300,auto); auto*=1000
  var tID; warnlayer._marker.on('move', function(e){clearTimeout(tID); tID=setTimeout(function(){warnlayer.getFeatureInfoJsonp({latlng:e.latlng})}, auto)});  //
  var t0=Date.now(); setInterval(function(){update()}, auto)  //add update alle 5 min
  document.addEventListener("visibilitychange", function(){if(!document.hidden) update()}, false);
  
  function update() {if(Date.now()-t0>=3*auto) {t0=Date.now(); warnlayer.setUrl("https://maps.dwd.de/geoserver/dwd/wms/?" + Math.random());
   karte.attributionControl.setPrefix(new Date().toLocaleTimeString('de',{hour:"2-digit",minute:"2-digit"}))}}
  
//more addons
warnlayer._marker.on('move', function(e){ var data=warnlayer._data
     if(data.features.length){  //add notification
     var severity=["Minor","Moderate","Severe","Extreme"], warnlev=qs  //decodeURI(location.search.slice(1));
     if(isNaN(warnlev)?
     data.features.map(function(obj){return obj.properties.EVENT}).some(function(x){return (warnlev.split(",").indexOf(x)+1)}) :   //querystringparameter ?ereignis e.g. ?GLÄTTE
     data.features.map(function(obj){return obj.properties.SEVERITY}).some(function(x){return (severity.indexOf(x) >= warnlev)}))  //  ?warnlevel e.g. ?1
     showNotification(data.features.length)}
})

if(navigator.serviceWorker) navigator.serviceWorker.register('sw.js');
function showNotification(tx) {
  Notification.requestPermission(function(result) {
    if (result === 'granted') {
      navigator.serviceWorker.ready.then(function(registration) {
        registration.showNotification('DWD', {
          body: tx+' Warnungen!',
          icon: 'icons/warn.png',
          vibrate: [200, 100, 200, 100, 200, 100, 200],
          tag: 'vibration-sample'
        });
      });
    }
  });
}
if(typeof(Notification) != "undefined" &&qs!=="4") Notification.requestPermission();  //


L.Control.Watermark = L.Control.extend({ //image for geocode (OpenStreetMap)
  onAdd: function(map) {
    var img = L.DomUtil.create('img');
    img.src = 'icons/search.png'; ; img.alt="search"
    img.style.background = 'white';

    L.DomEvent.on(img, 'click', function(){this._geocode()}, this); //handler
    L.DomEvent.disableClickPropagation(img)

    return img;
  },
  _geocode: function(ort) {
      var q = ort||prompt("Ort", "");
      if (q) {
        fetch("https://nominatim.openstreetmap.org/search?q=" + q + "&format=json&limit=1")
          .then(function(response) {
            response.json().then(function(data) {var e = [data[0].lat,data[0].lon];
              karte.setView(e);
              warnlayer.getFeatureInfoJsonp({latlng: e})
            })
          })
      }
    }
    //, onRemove: function(map) { }   // Nothing to do here
});
L.control.watermark = function(opts) {return new L.Control.Watermark(opts)}
var geo=L.control.watermark({position: 'bottomright'}).addTo(karte)  //add geocode

  if(isNaN(qs) &&qs.match(/^ort=/)) {qs=qs.slice(4); if(qs.match(/^[\d,-\.]+$/)) warnlayer.getFeatureInfoJsonp({latlng: qs.split(",")});  //?ort=48.37,10.9
   else geo._geocode(qs); qs=''} else if(qs!=="0") karte.locate({setView: true, maxZoom: 8});  //add geolocation
  karte.on('locationfound', function(e){console.log(e.latitude+","+e.longitude); warnlayer.getFeatureInfoJsonp(e)})

karte.attributionControl.setPrefix('<a href="javascript:void(0)" id="legend">&#x24d8;</a>')  //add legend
document.getElementById("legend").addEventListener("click", function (){ var img=document.createElement("img");
  img.src="https://maps.dwd.de/geoserver/wms?REQUEST=GetLegendGraphic&version=1.3&format=image/png&width=20&height=20&layer=dwd:Warnungen_Gemeinden";
  document.querySelector("#kartencontainer").parentNode.insertBefore(img,document.querySelector("#kartencontainer").nextSibling)
 karte.attributionControl.setPrefix("") } )

})();
</script>

</body>
</html>
